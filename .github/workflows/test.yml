# =============================================================================
# GITHUB ACTIONS CI/CD PIPELINE
# Automation Testing DamnCRUD dengan Pytest Parallel
# =============================================================================

name: DamnCRUD Automation Test

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# Permissions untuk GITHUB_TOKEN
permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  BASE_URL: "http://localhost:8080"

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: badcrud
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"
          extensions: pdo, pdo_mysql, mysqli
          coverage: none

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r automation/requirements.txt

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Setup ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Start ChromeDriver
        run: |
          chromedriver --port=4444 &
          sleep 2

      - name: Import Database
        run: |
          mysql -h 127.0.0.1 -u root -proot badcrud < db/damncrud.sql

      - name: Update Database Config
        run: |
          sed -i "s/\$DATABASE_PASS = 'root123'/\$DATABASE_PASS = 'root'/g" functions.php
          sed -i "s/\$DATABASE_HOST = 'localhost'/\$DATABASE_HOST = '127.0.0.1'/g" functions.php
          sed -i "s/\$DATABASE_NAME = 'badcrud'/\$DATABASE_NAME = 'badcrud'/g" functions.php

      - name: Start PHP Server
        run: |
          php -S localhost:8080 > php_server.log 2>&1 &
          sleep 3
          echo "PHP Server started"

      - name: Verify Server
        run: |
          curl -v http://localhost:8080/login.php || true
          cat php_server.log || true

      - name: Run Tests
        run: |
          cd automation
          python -m pytest test_pytest.py \
            -n auto \
            --html=report.html \
            --self-contained-html \
            --junitxml=test-results.xml \
            -v \
            --tb=short
        env:
          DISPLAY: ":99"
          BASE_URL: "http://localhost:8080"
        continue-on-error: true

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            automation/report.html
            automation/test-results.xml
          if-no-files-found: ignore
          retention-days: 30

      - name: Publish Test Results
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: "automation/test-results.xml"
          check_name: "Test Results"
          fail_on_failure: false
          token: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: test
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Test Status
        run: |
          echo "Test job result: ${{ needs.test.result }}"
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ All tests passed!"
          else
            echo "⚠️ Some tests may have failed. Check the reports."
          fi
