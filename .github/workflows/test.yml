# =============================================================================
# GITHUB ACTIONS CI/CD PIPELINE
# Automation Testing DamnCRUD dengan Pytest Parallel
# =============================================================================
# File: .github/workflows/test.yml
# Trigger: Push ke branch main/master, Pull Request
# =============================================================================

name: DamnCRUD Automation Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # Manual trigger
  workflow_dispatch:

env:
  # Konfigurasi aplikasi
  BASE_URL: "http://localhost:81/DamnCRUD"
  DB_HOST: "127.0.0.1"
  DB_USER: "root"
  DB_PASSWORD: ""
  DB_NAME: "badcrud"

jobs:
  # ===========================================================================
  # JOB 1: SETUP & TEST
  # ===========================================================================
  test:
    runs-on: ubuntu-latest
    
    # Service containers
    services:
      # MySQL Database Service
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: badcrud
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      # -----------------------------------------------------------------------
      # STEP 1: Checkout repository
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # STEP 2: Setup PHP
      # -----------------------------------------------------------------------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, pdo_mysql, mysqli
          coverage: none

      # -----------------------------------------------------------------------
      # STEP 3: Setup Python
      # -----------------------------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # -----------------------------------------------------------------------
      # STEP 4: Install Python dependencies
      # -----------------------------------------------------------------------
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r DamnCRUD/automation/requirements.txt

      # -----------------------------------------------------------------------
      # STEP 5: Setup Chrome & ChromeDriver
      # -----------------------------------------------------------------------
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
      
      - name: Setup ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      # -----------------------------------------------------------------------
      # STEP 6: Import Database
      # -----------------------------------------------------------------------
      - name: Import Database
        run: |
          mysql -h 127.0.0.1 -u root -proot badcrud < DamnCRUD/db/damncrud.sql

      # -----------------------------------------------------------------------
      # STEP 7: Update database config
      # -----------------------------------------------------------------------
      - name: Update Database Config
        run: |
          sed -i "s/\$DATABASE_PASS = 'root123'/\$DATABASE_PASS = 'root'/g" DamnCRUD/functions.php
          sed -i "s/\$DATABASE_HOST = 'localhost'/\$DATABASE_HOST = '127.0.0.1'/g" DamnCRUD/functions.php

      # -----------------------------------------------------------------------
      # STEP 8: Start PHP Built-in Server
      # -----------------------------------------------------------------------
      - name: Start PHP Server
        run: |
          cd DamnCRUD
          php -S localhost:81 > /dev/null 2>&1 &
          sleep 3
          echo "PHP Server started on port 81"

      # -----------------------------------------------------------------------
      # STEP 9: Verify Server is Running
      # -----------------------------------------------------------------------
      - name: Verify Server
        run: |
          curl -s -o /dev/null -w "%{http_code}" http://localhost:81/login.php || echo "Server check"

      # -----------------------------------------------------------------------
      # STEP 10: Run Pytest in Parallel
      # -----------------------------------------------------------------------
      - name: Run Tests in Parallel
        run: |
          cd DamnCRUD/automation
          python -m pytest test_pytest.py \
            --numprocesses=auto \
            --html=report.html \
            --self-contained-html \
            --junitxml=test-results.xml \
            -v
        env:
          DISPLAY: ":99"
          BASE_URL: "http://localhost:81"

      # -----------------------------------------------------------------------
      # STEP 11: Upload Test Report
      # -----------------------------------------------------------------------
      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            DamnCRUD/automation/report.html
            DamnCRUD/automation/test-results.xml
          retention-days: 30

      # -----------------------------------------------------------------------
      # STEP 12: Publish Test Results
      # -----------------------------------------------------------------------
      - name: Publish Test Results
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: 'DamnCRUD/automation/test-results.xml'
          check_name: 'Test Results'
          fail_on_failure: true

  # ===========================================================================
  # JOB 2: NOTIFY (Optional)
  # ===========================================================================
  notify:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Test Status
        run: |
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ All tests passed!"
          else
            echo "❌ Some tests failed!"
            exit 1
          fi
